---
title: "Time to Respond (TTR)"
output:
  html_document:
    css: "style.css"
    includes:
      before_body: "navbar.html"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "..") })
---

```{r, include=FALSE}
# Libraries
libs <- c(
  "tidyverse",
  "reactable",
  "plotly",
  "ggplot2",
  "reshape2",
  "magrittr",
  "lubridate"
)
lapply(libs, library, c=T)

# Functions
source("functions.R")

# Data
notes_df <- read_log("../logs/notes.csv")
assigned_df <- read_log("../logs/assigned.csv")

# Options, configs, themes
theme_set(theme_minimal())
mta_goal <- read_yaml("../config.yaml")$goals$mta
mtr_goal <- read_yaml("../config.yaml")$goals$mtr
knitr::opts_chunk$set(echo = FALSE)
options(warn=-1)
```

```{r data-check}
mta <- "(no data yet)"
mtr <- "(no data yet)"
mta_under <- "(no data yet)"
mtr_under <- "(no data yet)"
btp <- "0%"; mtp <- "0%"; fp <- "0%"

# MTA is all based on priority notes
if_mta_exists <-
  notes_df %>%
  filter(grepl("^pri", note)) %>%
  check_data()

# MTI is all based on closure notes
if_mti_exists <-
  notes_df %>%
  filter(grepl("btp|mtp|fp", note)) %>%
  check_data()

# MTR requires both MTA and MTI
if_mtr_exists <- if_mta_exists & if_mti_exists
```

```{r mta-work, eval = if_mta_exists}
detect_df <- assigned_df %>%
  select(id, assigned_date, assigned_user) %>%
  subset(!is.na(assigned_date))

ack_df <- notes_df %>%
  subset(grepl("^pri",note)) %>%
  mutate(Date = as.Date(note_date)) %>%
  select(id, Date, Priority=note, acked=note_date)

mta_df <-
  left_join(detect_df, ack_df, by="id") %>%
  subset(!is.na(Priority)) %>%
  mutate(TA = as.double(acked - assigned_date, units="hours"))

mta <- mean(mta_df$TA) %>% round(2)

mta_under <- mta_df %>%
  mutate(under_goal = ifelse(TA<=mta_goal,1,0)) %$%
  mean(under_goal) %>%
  (function(x) paste0(round(x*100,2),"%"))

mta_by_user <- mta_df %>%
  group_by(assigned_user) %>%
  summarize(MTA = mean(TA), .groups="keep")

mta_by_date <- mta_df %>%
  group_by(Date) %>%
  summarize(MTA = mean(TA), .groups="keep")
```

```{r mti-work, eval = if_mti_exists}
closed_df <- notes_df %>%
  subset(grepl("^mtp|^fp|^btp",note)) %>%
  select(id, closed=note_date)

mti_df <-
  left_join(ack_df,closed_df,by="id") %>%
  left_join(detect_df, by="id") %>%
  subset(!is.na(closed)) %>% # don't calc MTI for detections that aren't closed
  mutate(TI = as.double(closed-acked, units="hours"))

mti_by_date <- mti_df %>%
  group_by(Priority, Date) %>%
  summarize(MTI = mean(TI, na.rm=TRUE), .groups="keep")

mti_by_user <- mti_df %>%
  group_by(Priority, assigned_user) %>%
  summarize(MTI = mean(TI, na.rm=TRUE), .groups="keep")
```

```{r mtr-work, eval= if_mtr_exists}
mtr_df <- mti_df %>%
  subset(!is.na(closed)) %>%
  mutate(TR = as.double(closed - assigned_date, units="hours"))

mtr <- mean(mtr_df$TR) %>% round(2)

mtr_under <- mtr_df %>%
  mutate(under_goal = ifelse(TR<=mtr_goal,1,0)) %$%
  mean(under_goal) %>%
  (function(x) paste0(round(x*100,2),"%"))

mtr_by_date <- mtr_df %>%
  group_by(Priority, Date) %>%
  summarize(MTR = mean(TR, na.rm=TRUE), .groups="keep")

mtr_by_user <- mtr_df %>%
  group_by(Priority, assigned_user) %>%
  summarize(MTR = mean(TR, na.rm=TRUE), .groups="keep")
```

This page explores your company's `Time to Respond (TTR)` metrics. First, overall TTR are given. Then, this is broken down into two halves: `Time to Acknowledge (TTA)` and `Time to Investigate (TTI)`. A visual guide of the components of TTR are found on the Info page.

## Top Level Stats

```{r, eval = if_mta_exists}
top_stats <- notes_df %>%
  filter(grepl("^btp|^mtp|^fp", note)) %>%
  mutate(
    btp = ifelse(grepl("^btp", note), 1, 0),
    mtp = ifelse(grepl("^mtp", note), 1, 0),
    fp = ifelse(grepl("^fp", note), 1, 0)
  )

percentify <- function(x, n) (x / n * 100) %>% paste0("%")

n <- nrow(top_stats)
btp <- top_stats$btp %>% percentify(n)
mtp <- top_stats$mtp %>% percentify(n)
fp <- top_stats$fp %>% percentify(n)
```

***

<div style="height:70px;">
<div>
  <div id="stat-col">Malicious true positives</div>
  <div id="stat-col">Benign true positives</div>
  <div id="stat-col">False positives</div>
</div>

<div>
  <div id="stat-col"> <a id="stat"> `r mtp` </a> </div>
  <div id="stat-col"> <a id="stat"> `r btp` </a> </div>
  <div id="stat-col"> <a id="stat"> `r fp` </a> </div>
</div>
</div>

***

## Time to Respond (Overall) {.tabset}

**Goal**: MTR of under `r mtr_goal` hours. **The overall mean time to detect was `r mtr` hours.**

**`r mtr_under`** of detections had an MTR below the goal.

```{r, eval = !if_mtr_exists, out.width='100%'}
msg <- "No data yet!\nAdd a priority & closure note to a detection\nto see this page populate."
par(mar = c(0,0,0,0))
plot(c(0, 1), c(0, 1), ann = F, bty = 'n', type = 'n', xaxt = 'n', yaxt = 'n')
text(x = 0.5, y = 0.5, msg, cex = 1.6, col = "black")
```

### Daily MTR

```{r, eval = if_mtr_exists, out.width='100%'}
ggplotly(
  mtr_by_date %>%
    ggplot() +
    geom_point(aes(x=Date, y=MTR)) +
    geom_hline(aes(yintercept=mtr_goal), color="red") +
    geom_smooth(aes(x=Date, y=MTR), formula = y ~ x, method = "loess")
)
```

*Note: Trendline will not populate until there are ~ 5 data points to smooth over.*

### Daily MTR (Histogram)

```{r, eval = if_mtr_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y"),
  mtr_by_date %>%
    ggplot(aes(x=MTR)) +
    geom_histogram(bins=10, aes(fill=after_stat(count))) +
    theme_minimal()
)
```

### MTA by Analyst

```{r, eval = if_mtr_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y"),
  mtr_by_user %>%
    ggplot(aes(x=assigned_user, y=MTR, fill=assigned_user)) +
    geom_bar(stat="identity")
)
```

### Table (Raw Data)

```{r, eval = if_mtr_exists, out.width='100%'}
mtr_df %>%
  mutate_if(is.numeric, funs(round(.,2))) %>%
  table()
```

## Time to Acknowledge

`Time to acknowledge` is the time between a detection being assigned to an analyst and a priority note being added to it. This is the first half of response. `MTA` stands for "Mean time to Acknowledge," and is investigated in the charts below.

```{r, eval = !if_mta_exists, out.width='100%'}
msg <- "No data yet!\nWrite a note with the keyword 'pri'\n to see this page populate."
par(mar = c(0,0,0,0))
plot(c(0, 1), c(0, 1), ann = F, bty = 'n', type = 'n', xaxt = 'n', yaxt = 'n')
text(x = 0.5, y = 0.5, msg, cex = 1.6, col = "black")
```

## Data {.tabset}

**Goal**: MTA of under `r mta_goal` hours. **The overall mean time to acknowledge was `r mta` hours.**

**`r mta_under`** of detections had an MTR below the goal.

### Daily MTA

```{r, eval = if_mta_exists, out.width='100%'}
ggplotly(
  mta_by_date %>%
    ggplot() +
    geom_point(aes(x=Date, y=MTA)) +
    geom_hline(aes(yintercept=mta_goal), color="red") +
    geom_smooth(aes(x=Date, y=MTA), formula = y ~ x, method = "loess")
)
```

*Note: Trendline will not populate until there are ~ 5 data points to smooth over.*

### Daily MTA (Histogram)

```{r, eval = if_mta_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y"),
  mta_by_date %>%
    ggplot(aes(x=MTA)) +
    geom_histogram(bins=10, aes(fill=after_stat(count))) +
    theme_minimal()
)
```

### MTA by Analyst

```{r, eval = if_mta_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y"),
  mta_by_user %>%
    ggplot(aes(x=assigned_user, y=MTA, fill=assigned_user)) +
    geom_bar(stat="identity")
)
```


### Table (Raw Data)

```{r, eval = if_mta_exists, out.width='100%'}
mta_df %>%
  mutate_if(is.numeric, funs(round(.,2))) %>%
  table()
```

## Download

Click the button below to save the latest MTD data as a `.csv`.

```{r, eval = if_mta_exists}
write_csv(mta_df, "../data/mta.csv")
```

<a id = "button" download="mta.csv" href="../data/mta.csv">Download</a>

------------------------------------------------------------------------

## Time to Investigate

`Mean time to investigate` is the average amount of time it took between a detection being assigned to an analyst and being marked as resolved.

When an analyst finishes their investigation, they determine whether the detection was a false positive (FP), benign true positive (BTP), or malicious true positive (MTP).

```{r, eval = !if_mti_exists, out.width='100%'}
msg <- "No data yet!\nWrite a note with the keyword 'btp' or 'mtp' or 'fp'\n to see this page populate."
par(mar = c(0,0,0,0))
plot(c(0, 1), c(0, 1), ann = F, bty = 'n', type = 'n', xaxt = 'n', yaxt = 'n')
text(x = 0.5, y = 0.5, msg, cex = 1.6, col = "black")
```

## Data {.tabset}

### Daily MTI

```{r, eval = if_mti_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y", "group"),
  mti_by_date %>%
    ggplot(aes(x=Date, y=MTI, group=Priority, color=Priority)) +
    geom_smooth(method="loess", formula = y ~ x) +
    geom_point()
)
```

### Daily MTI (Histogram)

```{r, eval = if_mti_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y", "group"),
  mti_by_date %>%
    ggplot(aes(x=MTI, group=Priority)) +
    geom_histogram(
      aes(fill=Priority),
      bins=80, alpha=0.7,
      position = 'identity'
    )
)
```

### MTI by Analyst

```{r, eval = if_mti_exists, out.width='100%'}
ggplotly(
  tooltip = c("x", "y", "group"),
  mti_by_user %>%
    ggplot(aes(x=assigned_user, y=MTI, fill=assigned_user)) +
    geom_bar(stat="identity")
)
```

### Table

```{r, eval = if_mti_exists, out.width='100%'}
mti_df %>%
  mutate_if(is.numeric, funs(round(.,2))) %>%
  reactable()
```

## Download

Click the button below to save the latest MTI data as a `.csv`.

```{r, eval = if_mti_exists}
write_csv(mti_df, "../data/mti.csv")
```

<a id="button" download="mti.csv" href="../data/mti.csv">Download</a>
<div class="spacer"></div>